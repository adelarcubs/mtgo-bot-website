{% extends "@layout/admin.html.twig" %}

{% block title %}MTGO Sets{% endblock %}

{% block javascript %}
    {{ parent() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle Import Sets button click
            const importSetsBtn = document.getElementById('import-sets-btn');
            if (importSetsBtn) {
                importSetsBtn.addEventListener('click', async function() {
                    const button = this;
                    const originalContent = button.innerHTML;
                    const originalClass = button.className;
                    
                    try {
                        // Show loading state
                        button.disabled = true;
                        button.classList.remove('btn-outline-success');
                        button.classList.add('btn-secondary');
                        button.innerHTML = `
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Importing Sets...
                        `;
                        
                        // Make the API call to import sets
                        const response = await fetch('{{ path('admin.mtgo-sets.import') }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            credentials: 'same-origin'
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        showToast(data.message || 'Sets imported successfully', 'success');
                        
                        // Reload the page after a short delay to show the new sets
                        setTimeout(() => window.location.reload(), 1500);
                        
                    } catch (error) {
                        console.error('Failed to import sets:', error);
                        showToast(error.message || 'Failed to import sets. Please try again.', 'danger');
                    } finally {
                        // Reset button state
                        button.disabled = false;
                        button.className = originalClass;
                        button.innerHTML = originalContent;
                    }
                });
            }
            
            // Handle Import All Cards button click
            const importAllCardsBtn = document.getElementById('import-all-cards-btn');
            if (importAllCardsBtn) {
                importAllCardsBtn.addEventListener('click', function() {
                    const importButtons = document.querySelectorAll('.import-cards');
                    if (importButtons.length > 0) {
                        // Show a confirmation dialog
                        if (confirm(`Are you sure you want to import cards for all ${importButtons.length} sets? This may take a while.`)) {
                            // Disable the import all button
                            importAllCardsBtn.disabled = true;
                            importAllCardsBtn.innerHTML = `
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                Importing...
                            `;
                            
                            // Click all import buttons with a small delay between each
                            let delay = 0;
                            importButtons.forEach((btn, index) => {
                                setTimeout(() => {
                                    if (!btn.disabled) {
                                        btn.click();
                                    }
                                    
                                    // Re-enable the import all button after the last import starts
                                    if (index === importButtons.length - 1) {
                                        setTimeout(() => {
                                            importAllCardsBtn.disabled = false;
                                            importAllCardsBtn.innerHTML = `
                                                <i class="bi bi-download-all"></i> Import All Cards
                                            `;
                                        }, 1000);
                                    }
                                }, delay);
                                delay += 1000; // 1 second delay between each import
                            });
                        }
                    } else {
                        showToast('No importable sets found', 'warning');
                    }
                });
            }
            
            // Handle Import Cards button clicks
            // Add click event listener to all import buttons
            document.querySelectorAll('.import-cards').forEach(button => {
                button.addEventListener('click', async function() {
                    const code = this.dataset.code;
                    const button = this;
                    const row = button.closest('tr');
                    const url = `/admin/mtgo-sets/import/set-cards/${encodeURIComponent(code)}`;
                    
                    // Create a unique ID for this import operation
                    const importId = `import-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    
                    // Save original button state
                    const originalContent = button.innerHTML;
                    const originalClass = button.className;
                    
                    try {
                        // Show loading state for this specific button
                        button.disabled = true;
                        button.classList.remove('btn-outline-success');
                        button.classList.add('btn-secondary');
                        button.innerHTML = `
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Importing...
                        `;
                        
                        // Add loading class to the row
                        row.classList.add('table-active');
                        
                        // Make the API call
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-Import-ID': importId
                            },
                            credentials: 'same-origin'
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        // Show success message with the specific import ID
                        showToast(`Successfully imported cards for ${code} (${importId})`, 'success');
                        
                    } catch (error) {
                        console.error(`Import ${importId} failed:`, error);
                        showToast(`Failed to import cards for ${code}. Please try again.`, 'danger');
                    } finally {
                        // Always reset the button and row state
                        button.disabled = false;
                        button.className = originalClass;
                        button.innerHTML = originalContent;
                        row.classList.remove('table-active');
                    }
                });
            });
            
            // Helper function to show toast messages
            function showToast(message, type = 'info') {
                const toastContainer = document.getElementById('toast-container') || (() => {
                    const container = document.createElement('div');
                    container.id = 'toast-container';
                    container.style.position = 'fixed';
                    container.style.top = '20px';
                    container.style.right = '20px';
                    container.style.zIndex = '1100';
                    document.body.appendChild(container);
                    return container;
                })();
                
                const toast = document.createElement('div');
                const toastId = `toast-${Date.now()}`;
                const typeClass = `bg-${type} text-white`;
                
                toast.id = toastId;
                toast.className = `toast align-items-center ${typeClass} border-0 mb-2`;
                toast.setAttribute('role', 'alert');
                toast.setAttribute('aria-live', 'assertive');
                toast.setAttribute('aria-atomic', 'true');
                
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                `;
                
                toastContainer.appendChild(toast);
                const bsToast = new bootstrap.Toast(toast, {
                    autohide: true,
                    delay: 3000
                });
                
                // Auto-remove the toast after it's hidden
                toast.addEventListener('hidden.bs.toast', function() {
                    toast.remove();
                });
                
                bsToast.show();
            }
        });
    </script>
{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">MTGO Sets</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" id="import-sets-btn" class="btn btn-sm btn-outline-success">
                    <i class="bi bi-download"></i> Import Sets
                </button>
                <button type="button" id="import-all-cards-btn" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-download-all"></i> Import All Cards
                </button>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Code</th>
                    <th>Release Date</th>
                    <th>Last Import</th>
                    <th>Last Items Import</th>
                    <th>Cards</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for set in cardSets %}
                    <tr>
                        <td>{{ set.name }}</td>
                        <td><code>{{ set.code }}</code></td>
                        <td>{{ set.release ? set.release|date('Y-m-d') : 'N/A' }}</td>
                        <td>{{ set.lastImportAt ? set.lastImportAt|date('Y-m-d H:i:s') : 'Never' }}</td>
                        <td>{{ set.lastImportItemsAt ? set.lastImportItemsAt|date('Y-m-d H:i:s') : 'Never' }}</td>
                        <td>
                            {% if set.totalSetSize %}
                                {{ set.totalSetSize }} (Base: {{ set.baseSetSize ?? 'N/A' }})
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-success import-cards" data-code="{{ set.code }}" title="Import Cards">
                                    <i class="bi bi-download"></i> Import Cards
                                </button>
                                <a href="#" class="btn btn-outline-primary" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <a href="#" class="btn btn-outline-danger" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center">No MTGO sets found.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}
